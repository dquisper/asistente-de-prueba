<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototipo Asistente Virtual "Inti"</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble-inti {
            background-color: #f0f4f8; /* Un azul claro y suave */
            color: #1e293b;
            border-radius: 20px 20px 20px 5px;
        }
        .chat-bubble-user {
            background-color: #007bff; /* Un azul más vibrante para el usuario */
            color: #ffffff;
            border-radius: 20px 20px 5px 20px;
        }
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .thinking-bubble::after {
            content: '...';
            display: inline-block;
            animation: thinking 1.5s infinite;
        }
        @keyframes thinking {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        #share-notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-4 bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh]">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-5 rounded-t-2xl shadow-md flex justify-between items-center">
            <div class="flex items-center justify-start space-x-3">
                 <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                <div>
                    <h1 class="text-2xl font-bold">Inti</h1>
                    <p class="text-sm opacity-90">Asistente Virtual de Concytec</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="share-btn-header" title="Compartir" class="p-2 rounded-full hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
                </button>
                <button id="download-btn-header" title="Descargar HTML" class="p-2 rounded-full hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                </button>
            </div>
        </header>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-4">
            <!-- Los mensajes del chat se agregarán aquí -->
        </div>

        <!-- Options Container -->
        <div id="options-container" class="p-4 border-t border-gray-200">
            <!-- Las opciones para el usuario se agregarán aquí -->
        </div>

        <!-- Input Container -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
            <div class="flex space-x-3">
                <input type="text" id="free-text-input" class="flex-1 p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" placeholder="Escribe tu pregunta...">
                <button id="send-btn" class="px-5 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Share Notification -->
    <div id="share-notification" class="fixed bottom-5 right-5 bg-gray-900 text-white px-5 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-4 pointer-events-none">
        ¡Enlace copiado al portapapeles!
    </div>


    <script>
        const chatContainer = document.getElementById('chat-container');
        const optionsContainer = document.getElementById('options-container');
        const freeTextInput = document.getElementById('free-text-input');
        const sendBtn = document.getElementById('send-btn');
        const shareBtnHeader = document.getElementById('share-btn-header');
        const downloadBtnHeader = document.getElementById('download-btn-header');
        const shareNotification = document.getElementById('share-notification');

        // --- DEFINICIÓN DE FLUJOS ---

        const flows = {
            start: {
                message: "¡Hola! Soy Inti, tu asistente virtual de Concytec. Estoy aquí para ayudarte a explorar el fascinante mundo de la investigación. ¿En qué etapa de tu carrera te encuentras?",
                options: {
                    "Quiero empezar a investigar, ¿por dónde empiezo?": "flow_primeros_pasos",
                    "Busco financiamiento para mi proyecto.": "flow_financiamiento",
                    "¿Qué es el registro CTI Vitae (antes DINA)?": "flow_cti_vitae",
                    "Quiero conocer los programas y becas de Concytec.": { message: "¡Excelente elección! Concytec, a través de su brazo ejecutor Prociencia, ofrece una variedad de programas y becas. Puedes encontrar todas las convocatorias vigentes en el portal de Prociencia. ¿Hay algo más en lo que pueda ayudarte?", options: { "Volver al inicio": "start" } }
                }
            },
            flow_primeros_pasos: {
                message: "¿En qué campo del conocimiento te gustaría investigar?",
                options: {
                    "Ciencias de la salud": "primeros_pasos_recursos",
                    "Ingeniería": "primeros_pasos_recursos",
                    "Ciencias sociales": "primeros_pasos_recursos",
                    "Otro": "primeros_pasos_recursos"
                }
            },
            primeros_pasos_recursos: {
                message: "Excelente. Un buen punto de partida es familiarizarte con las líneas de investigación prioritarias para el país. También te recomiendo explorar la base de datos de proyectos financiados por Concytec para inspirarte. \n\nAdemás, puedo ayudarte a encontrar investigadores o grupos de investigación registrados en tu área. ¿Te gustaría buscar en nuestra red de científicos?",
                options: {
                    "Sí, buscar en la red": { message: "Perfecto. Para iniciar la búsqueda, te invito a visitar el Directorio Nacional de Investigadores e Innovadores (DINA), ahora integrado en CTI Vitae. Allí podrás filtrar por especialidad y encontrar expertos en tu campo. ¿Necesitas algo más?", options: { "Volver al inicio": "start" } },
                    "No, gracias": { message: "Entendido. Si cambias de opinión, no dudes en consultarme. ¿Hay algo más en lo que pueda ayudarte?", options: { "Volver al inicio": "start" } }
                }
            },
            flow_financiamiento: {
                message: "¿Qué tipo de financiamiento buscas?",
                options: {
                    "Para tesis": "financiamiento_info",
                    "Para un proyecto de investigación": "financiamiento_info",
                    "Para una startup de base tecnológica": "financiamiento_info",
                    "Para una pasantía": "financiamiento_info"
                }
            },
            financiamiento_info: {
                message: "Perfecto. Actualmente, tenemos abiertas convocatorias para Proyectos de Investigación Básica y Aplicada. Puedes revisar todos los detalles y postular en nuestro portal. \n\n¿Necesitas consejos para preparar tu propuesta o quieres saber más sobre los criterios de evaluación?",
                options: {
                    "Sí, quiero consejos": { message: "¡Claro! Un buen consejo es leer detenidamente las bases de la convocatoria, alinear tu proyecto con los objetivos nacionales de CTI y asegurarte de que tu metodología sea clara y sólida. ¡Mucho éxito en tu postulación! ¿Algo más?", options: { "Volver al inicio": "start" } },
                    "No, gracias": { message: "De acuerdo. ¡Te deseo mucho éxito con tu postulación! Si tienes más dudas, aquí estaré. ¿Hay algo más en lo que pueda ayudarte?", options: { "Volver al inicio": "start" } }
                }
            },
            flow_cti_vitae: {
                message: "El CTI Vitae es el Directorio Nacional de Investigadores e Innovadores. Estar registrado aquí es fundamental para ser visible en el sistema nacional de ciencia y tecnología y para poder postular a la mayoría de nuestros fondos y programas. \n\nEl registro es online. Necesitarás tu DNI, información académica y tu producción científica (si la tienes). Puedo darte el enlace directo al portal y una guía paso a paso. ¿Te la envío?",
                options: {
                    "Sí, envíame la guía": { message: "Genial. Puedes acceder al portal de registro a través de cti.concytec.gob.pe y encontrarás guías detalladas en la sección de ayuda. ¡Es un paso muy importante para tu carrera de investigador! ¿Puedo ayudarte en algo más?", options: { "Volver al inicio": "start" } },
                    "No, gracias": { message: "Entendido. Recuerda que es un requisito importante. Si tienes alguna pregunta más adelante, no dudes en consultarme. ¿Hay algo más en lo que pueda ayudarte?", options: { "Volver al inicio": "start" } }
                }
            }
        };

        // --- FUNCIONES DEL CHAT ---

        function addMessage(text, sender, isThinking = false) {
            const bubble = document.createElement('div');
            bubble.className = `max-w-xs md:max-w-md p-3 mb-2 break-words ${sender === 'inti' ? 'chat-bubble-inti self-start' : 'chat-bubble-user self-end'}`;
            bubble.textContent = text;
            if (isThinking) {
                bubble.classList.add('thinking-bubble');
            }
            chatContainer.appendChild(bubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return bubble;
        }

        function showOptions(options) {
            optionsContainer.innerHTML = '';
            if (!options) return;
            const optionsWrapper = document.createElement('div');
            optionsWrapper.className = 'grid grid-cols-1 sm:grid-cols-2 gap-3';
            
            for (const text in options) {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = 'w-full p-3 bg-white border border-blue-500 text-blue-600 rounded-lg hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors duration-200 text-sm';
                button.onclick = () => handleOptionClick(text, options[text]);
                optionsWrapper.appendChild(button);
            }
            optionsContainer.appendChild(optionsWrapper);
        }

        function handleOptionClick(text, next) {
            addMessage(text, 'user');
            optionsContainer.innerHTML = '';

            let nextFlow;
            if (typeof next === 'string') {
                nextFlow = flows[next];
            } else {
                nextFlow = next;
            }

            if (nextFlow) {
                setTimeout(() => {
                    addMessage(nextFlow.message, 'inti');
                    if (nextFlow.options) {
                        showOptions(nextFlow.options);
                    }
                }, 500);
            }
        }
        
        async function callGeminiAPI(userQuery) {
            // VITAL: Reemplaza la siguiente cadena vacía con tu propia API Key de Google AI Studio.
            // ¡ADVERTENCIA! No compartas este código en un repositorio público de GitHub con tu clave visible.
            const apiKey = "AIzaSyCUTZz-2faNAXy7kLR1KJI7vO_leADiNNU";
            
            if (apiKey === "AIzaSyCUTZz-2faNAXy7kLR1KJI7vO_leADiNNU" || apiKey === "AIzaSyCUTZz-2faNAXy7kLR1KJI7vO_leADiNNU") {
                throw new Error("API Key no configurada.");
            }

            const systemPrompt = `Eres "Inti", un asistente virtual experto de Concytec (Consejo Nacional de Ciencia, Tecnología e Innovación Tecnológica del Perú). Tu rol es guiar a profesionales y estudiantes peruanos en su camino hacia la investigación científica y tecnológica. Tu tono debe ser profesional, amigable, proactivo y motivador. Tu misión es resolver dudas, conectar a los usuarios con oportunidades y recursos, y fomentar el desarrollo de la ciencia en el Perú. Debes ser claro, conciso y siempre dispuesto a ayudar. Basa tus respuestas en la información más reciente disponible en la web. Responde en español.`;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            throw new Error("Respuesta de la API inválida.");
                        }
                    } else if (response.status >= 500) {
                         throw new Error(`Error del servidor: ${response.status}`);
                    } else {
                         const errorResult = await response.json();
                         throw new Error(`Error de la API: ${errorResult.error?.message || 'Error desconocido'}`);
                    }
                } catch (error) {
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
             throw new Error("Se superó el número máximo de reintentos.");
        }

        async function handleFreeTextSubmit() {
            const userText = freeTextInput.value.trim();
            if (userText === '') return;

            addMessage(userText, 'user');
            freeTextInput.value = '';
            optionsContainer.innerHTML = '';
            sendBtn.disabled = true;

            const thinkingMessage = addMessage("Inti está pensando", 'inti', true);

            try {
                const botResponse = await callGeminiAPI(userText);
                thinkingMessage.remove();
                addMessage(botResponse, 'inti');
            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                thinkingMessage.remove();
                addMessage(`Lo siento, tuve un problema al buscar la información. Parece ser un error de configuración. (Detalle: ${error.message})`, 'inti');
            } finally {
                setTimeout(() => {
                    addMessage("¿Hay algo más en lo que pueda ayudarte?", 'inti');
                    showOptions(flows.start.options);
                    sendBtn.disabled = false;
                }, 500);
            }
        }

        function showShareNotification() {
            shareNotification.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => {
                shareNotification.classList.add('opacity-0', 'translate-y-4');
            }, 2500);
        }

        async function handleShare() {
            const shareData = {
                title: 'Asistente Virtual Inti - Concytec',
                text: 'Chatea con Inti, el asistente virtual de Concytec para guiarte en tu camino como investigador.',
                url: window.location.href
            };
            try {
                 if (navigator.share) {
                    await navigator.share(shareData);
                 } else {
                    throw new Error('Web Share API not supported');
                 }
            } catch (err) {
                // Fallback: copy to clipboard
                const textArea = document.createElement("textarea");
                textArea.value = shareData.url;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showShareNotification();
                } catch (copyErr) {
                    console.error('Fallback: Oops, unable to copy', copyErr);
                }
                document.body.removeChild(textArea);
            }
        }
        
        function handleDownload() {
            const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inti_prototype.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startChat() {
            const startFlow = flows.start;
            addMessage(startFlow.message, 'inti');
            showOptions(startFlow.options);
        }

        // Event Listeners
        sendBtn.onclick = handleFreeTextSubmit;
        shareBtnHeader.onclick = handleShare;
        downloadBtnHeader.onclick = handleDownload;
        freeTextInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleFreeTextSubmit();
            }
        });

        // Iniciar la conversación al cargar la página
        window.onload = startChat;
    </script>
</body>
</html>
